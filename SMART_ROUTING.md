# Smart Routing - –í–µ–Ω–µ—Ä–∞ –≠–º–Ω—ç–ª—ç–≥–∏–π–Ω 5 –¢–∞—Å–≥–∏–π–Ω –£—Ç–∞—Å–Ω—ã –î—É–≥–∞–∞—Ä

##Ê¶ÇË¶Å

–í–µ–Ω–µ—Ä–∞ V.I.P Clinic-–¥ 5 ”©”©—Ä ”©”©—Ä —Ç–∞—Å–∞–≥—Ç–∞–π:
- ü¶∑ **–®“Ø–¥–Ω–∏–π —Ç–∞—Å–∞–≥** (Dental)
- üåø **–£–ª–∞–º–∂–ª–∞–ª—Ç –∞–Ω–∞–≥–∞–∞** (Traditional)
- üíß **–î—É—Å–∞–ª / –°—É–≤–∏–ª–∞—Ö—É–π** (Drip)
- üíâ **–ú—ç—Å–∏–π–Ω –±—É—Å –≥–æ–æ —Å–∞–π—Ö–∞–Ω** (Non-surgical)
- üè• **–ú—ç—Å –∑–∞—Å–∞–ª** (Surgical)

”®–≤—á—Ç”©–Ω”©”©—Å SMS –º–µ—Å—Å–µ–∂ –∞–≤–∞—Ö–¥–∞–∞ —Ç—É—Å —Ç—É—Å—ã–Ω —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞.

## “Æ–π–ª –∞–∂–∏–ª–ª–∞–≥–∞–∞

### 1. –¢–∞—Å–≥—É—É–¥—ã–Ω –£—Ç–∞—Å–Ω—ã –î—É–≥–∞–∞—Ä—ã–≥ –¢–æ—Ö–∏—Ä—É—É–ª–∞—Ö

[SMS –ú–µ—Å—Å–µ–∂–∏–π–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ](http://localhost/sms_messages.php) —Ö—É—É–¥–∞—Å—Ç –æ—Ä–Ω–æ. 

**"–¢–∞—Å–≥—É—É–¥—ã–Ω —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä (–í–µ–Ω–µ—Ä–∞ —ç–º–Ω—ç–ª—ç–≥)"** —Ö—ç—Å—ç–≥—Ç –æ—Ä–∂:
- –®“Ø–¥–Ω–∏–π —Ç–∞—Å–∞–≥: `70115090` ‚Üí ”®”©—Ä –¥—É–≥–∞–∞—Ä—ã–≥ –æ—Ä—É—É–ª–∂ –±–æ–ª–Ω–æ
- –£–ª–∞–º–∂–ª–∞–ª—Ç –∞–Ω–∞–≥–∞–∞: `70115090` ‚Üí ”©”©—Ä –¥—É–≥–∞–∞—Ä—ã–≥ –æ—Ä—É—É–ª–∂ –±–æ–ª–Ω–æ
- ... –≥—ç—Ö –º—ç—Ç

![Department Phones UI](docs/department_phones_ui.png)

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏–∫ –°–æ–Ω–≥–æ–ª—Ç

Booking “Ø“Ø—Å–≥—ç—Ö–¥—ç—ç `service_name` —Ö—ç–º—ç—ç—Ö —Ç–∞–ª–±–∞—Ä –±–∞–π–¥–∞–≥. –ñ–∏—à—ç—ç –Ω—å:
- `–®“Ø–¥–Ω–∏–π “Ø–∑–ª—ç–≥` ‚Üí –®“Ø–¥–Ω–∏–π —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞
- `–£–ª–∞–º–∂–ª–∞–ª—Ç –º–∞—Å—Å–∞–∂` ‚Üí –£–ª–∞–º–∂–ª–∞–ª—Ç —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞
- `IV –¥—É—Å–∞–ª` ‚Üí –î—É—Å–∞–ª —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞
- `–ë–æ—Ç–æ–∫—Å` ‚Üí –ú—ç—Å–∏–π–Ω –±—É—Å —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞
- `–•–∏—Ä—É—Ä–≥–∏–π–Ω “Ø–π–ª—á–∏–ª–≥—ç—ç` ‚Üí –ú—ç—Å –∑–∞—Å–∞–ª —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞

### 3. –ò–ª–≥—ç—ç–ª—Ç–∏–π–Ω –ü—Ä–æ—Ü–µ—Å—Å

#### –ë–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç—ã–Ω –º–µ—Å—Å–µ–∂ (confirmation)
Booking “Ø“Ø—Å–≥—ç–≥–¥—ç–ª ‚Üí API –¥—É—É–¥–ª–∞–≥–∞ ‚Üí `sendSMS()` –¥“Ø—Ä—ç–ª—Ç—ç–π:
- Service name –¥—ç—ç—Ä—ç—ç—Å department —Å–æ–Ω–≥–æ–ª—Ç
- `getPhoneForDepartment()` –¥—É—É–¥–ª–∞–≥–∞ ‚Üí —Ç—É—Å —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä
- Template –¥—ç—ç—Ä `{phone}` placeholder —Å–æ–ª–∏–≥–¥–æ–Ω–∞
- SMS —è–≤—É—É–ª–Ω–∞

#### –°–∞–Ω—É—É–ª–≥–∞ –º–µ—Å—Å–µ–∂ (reminder)
`cron_sms.php` —ç—Ö–ª—ç–ª—Ç—ç—ç—Ä:
- –ú–∞—Ä–≥–∞–∞—à “Ø–∑–ª—ç–≥—Ç—ç–π ”©–≤—á—Ç”©–Ω –æ–ª–Ω–æ
- `getPhoneForDepartment()` –∞—à–∏–≥–ª–∞–Ω —Ç–∞—Å —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å —Å–æ–Ω–≥–æ–ª—Ç
- SMS —è–≤—É—É–ª–Ω–∞

## Database Schema

### app_settings Table
```sql
SELECT * FROM app_settings WHERE clinic = 'venera' AND key = 'department_phones';
```

Example value:
```json
{
  "dental": "70115090",
  "traditional": "70115090",
  "drip": "70115090",
  "nonsurgical": "70115090",
  "surgical": "70115090"
}
```

## –ö–æ–¥ –•—ç—Ä—ç–≥–∂“Ø“Ø–ª—ç–ª—Ç

### getPhoneForDepartment() Function
`config.php` –¥—ç—ç—Ä –±–∞–π–≥–∞–∞ (line ~165):

```php
function getPhoneForDepartment($booking_id, $clinic = 'venera', $default_phone = '70115090') {
    // 1. Booking –æ–ª–Ω–æ
    // 2. Service name –∞–≤–Ω–∞
    // 3. Department map –¥—ç—ç—Ä—ç—ç —Ö–∞–π–Ω–∞ (keyword matching)
    // 4. app_settings –¥—ç—ç—Ä—ç—ç—Å department phone –∞–≤–Ω–∞
    // 5. –•—ç—Ä—ç–≤ –±–∞–π—Ö–≥“Ø–π –±–æ–ª default phone –±—É—Ü–∞–∞–Ω–∞
}
```

**Keyword Mapping:**
- `dental`: '—à“Ø–¥', 'tooth', 'dent'
- `traditional`: '—É–ª–∞–º–∂–ª–∞–ª—Ç', 'traditional', '—Ö”©–Ω–≥”©'
- `drip`: '–¥—É—Å–∞–ª', '—Å—É–≤–∏–ª–∞—Ö—É–π', 'drip', 'iv'
- `nonsurgical`: '–º—ç—Å–∏–π–Ω –±—É—Å', '–≥–æ–æ —Å–∞–π—Ö–∞–Ω', 'nonsurgical', 'botox'
- `surgical`: '–º—ç—Å', '–∑–∞—Å–∞–ª', '—Ö–∏—Ä—É—Ä–≥', 'surgical'

### SMS Template Placeholder

SMS template –¥—ç—ç—Ä `{phone}` –∞—à–∏–≥–ª–∞—Ö:
```
Sain baina uu! Tany zahalga {clinic_name}-d {date} {start_time}-d batalguajlaa. Uts: {phone}.
```

- `{clinic_name}`: "Venera V.I.P Clinic"
- `{date}`: "12-25" (–º–º-–¥–¥)
- `{start_time}`: "14:00"
- `{phone}`: –°–æ–Ω–≥–æ–≥–¥—Å–æ–Ω —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å

## Testing

### Test Case 1: Dental Service
```bash
curl -X POST http://localhost/api.php?action=create \
  -H "Content-Type: application/json" \
  -d '{
    "doctor_id": 2,
    "clinic": "venera",
    "date": "2025-12-25",
    "start_time": "14:00",
    "end_time": "15:00",
    "patient_name": "–¢–µ—Å—Ç ”©–≤—á—Ç”©–Ω”©",
    "phone": "88168812",
    "service_name": "–®“Ø–¥–Ω–∏–π “Ø–∑–ª—ç–≥"
  }'
```

SMS –º–µ—Å—Å–µ–∂ –¥—ç—ç—Ä —à“Ø–¥–Ω–∏–π —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å —è–≤—É—É–ª–∞–≥–¥–∞–Ω–∞.

### Test Case 2: Custom Phone
SMS Messages —Ö—É—É–¥—Å–∞–∞—Å "–¢–µ—Å—Ç —è–≤—É—É–ª–∞—Ö" –¥—ç—ç—Ä —Å–æ–Ω–≥–æ—Å–æ–Ω —É—Ç–∞—Å –¥—ç—ç—Ä —Ç–µ—Å—Ç–∏–π–Ω –º–µ—Å—Å–µ–∂ —è–≤—É—É–ª–∂ –±–æ–ª–Ω–æ.

## Troubleshooting

**Q: Department phone field —Ö–æ–æ—Å–æ–Ω “Ø–ª–¥—Å—ç–Ω, —è–∞–∂ –±–æ–ª–æ—Ö –≤—ç?**
- A: Default clinic phone (70115090) –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞

**Q: Service name —è–≥ –±–∞–π—Ö —ë—Å–≥“Ø–π —é—É?**
- A: Keyword matching –∞—à–∏–≥–ª–∞–¥–∞–≥. "–®“Ø–¥–Ω–∏–π" –≥—ç–¥—ç–≥ “Ø–≥–∏–π–≥ –∞–≥—É—É–ª—Å–∞–Ω service –Ω—å —à“Ø–¥–Ω–∏–π —Ç–∞—Å–≥–∏–π–Ω —É—Ç–∞—Å –∞–≤–Ω–∞.

**Q: Khatan —ç–º–Ω—ç–ª—ç–≥ –¥—ç—ç—Ä –º”©–Ω –∏–π–º –±–∞–π—Ö —É—É?**
- A: –î–∞–∞—Ä–∞–∞ –Ω—ç–º–∂ –±–æ–ª–Ω–æ. –û–¥–æ–æ–≥–æ–æ—Ä –í–µ–Ω–µ—Ä–∞ –¥—ç—ç—Ä—Ö –ª –±–∞–π–≥–∞–∞.

## File References

- **Config:** `config.php` (line ~165, getPhoneForDepartment function)
- **UI:** `public/sms_messages.php` (Department Phones section)
- **Cron:** `cron_sms.php` (Smart routing applied to reminders)
- **Database:** app_settings table with JSON value
